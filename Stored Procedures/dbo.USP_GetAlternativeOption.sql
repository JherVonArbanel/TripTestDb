SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- Exec USP_GetAlternativeOption 48293, 'RoundTrip', '(all),K5,M3,GB,ZY,KI,JP,DF,A3,RE,EI,EE,E4,JR,DW,Q6,AJ,M0,P5,7L,2B,SU,D9,5N,2K,KG,AR,5D,VW,AM,QO,HT,WL,5L,VV,M7,UJ,FK,XU,6F,8U,ZI,2D,AH,A6,G9,KC,CC,UU,BT,AB,BP,2J,8Y,TY,SB,AC,QK,TX,2Q,NV,CA,3E,A7,AG,QC,YN,HD,EN,UX,PC,OF,AF,GL,NY,AI,3H,VU,JM,NQ,JS,WJ,NX,MD,QM,KM,6T,CW,MR,MK,ML,ZV,6M,9U,RM,SW,NZ,7A,EL,EH,PX,4N,YW,AP,N6,FJ,2P,GZ,S2,PJ,HM,4D,YI,VT,TN,TC,TS,JY,DO,NF,ZW,UM,AK,ED,RU,YQ,DV,4C,QP,A5,ND,FA,1A,TL,FL,ZU,6L,AS,J5,LV,4H,AZ,XM,G4,QQ,3A,C4,AQ,5A,6R,HP,AA,MQ,M6,NH,9N,OY,O4,5F,FG,W3,IZ,U8,MV,JW,8A,U3,R7,6K,OZ,ER,5W,TZ,RC,EV,TD,5Y,KK,V8,IP,IQ,GR,AU,OS,6A,7U,EC,AV,WR,GU,Z3,9V,L9,9Y,J2,ZE,UP,PG,8W,JV,B2,LZ,O3,B3,CH,8E,J8,GQ,BG,NT,5Z,BV,QW,KF,BF,BD,WW,7R,K6,Z2,BQ,FQ,DB,BA,KJ,SN,TV,FB,UZ,5C,MO,UY,5T,C6,9K,2G,W8,CV,BW,V3,RV,CX,KX,XK,5J,9M,J7,WE,OP,5B,CI,CK,MU,G5,CZ,KN,A2,QI,C9,CF,X9,WX,QA,XG,6P,BX,DQ,9L,OH,MN,C5,KR,I5,CP,DE,C3,CS,V0,CM,SS,OU,OK,CU,CY,D3,N2,WD,0D,DI,JD,H8,DL,3D,D0,D8,E3,7D,R6,KA,KB,9H,QU,B5,DS,WK,MS,9J,LY,EK,EM,7H,B8,OV,ET,EY,UI,GJ,K2,3W,EA,QY,EW,BR,EZ,3Z,OW,8D,XE,EF,FX,4S,AY,FC,7F,PA,RF,D7,E7,SH,F7,BE,FY,Y2,TE,LF,BN,HK,F8,F9,2F,FH,GY,6G,7O,GA,GT,A9,QB,4U,G0,Z5,GK,G7,G3,DC,GS,ZK,IJ,GF,3M,HR,HU,HF,H3,HQ,HA,BH,YO,H4,JB,HJ,2L,DU,5K,4R,8H,H5,HX,UO,QX,6I,II,IB,FW,X8,FI,4I,IC,6E,QZ,O9,7I,D6,ZA,ID,IR,B9,EP,IA,WP,IS,Q2,IF,WC,6H,GI,JL,JC,JO,3X,EG,NU,JU,7C,QJ,9W,J0,LS,8J,B6,JQ,GX,R5,6J,HO,K4,E2,6S,KV,4K,KQ,YK,IT,Y9,KP,KL,WA,7K,KE,7B,KU,QH,A0,JF,LB,LR,N7,TM,LA,4M,UC,XL,LP,LU,IL,QV,LE,6Y,NG,HE,LI,LN,4V,LM,LO,LT,LH,CL,LG,5V,L2,IN,W5,MH,MA,TF,RI,AE,6V,MP,FZ,MY,MW,IM,IG,MZ,YV,XJ,MX,OM,ME,YX,AL,MJ,M_,7G,MB,2M,ZB,YM,M9,8I,UB,8M,VZ,UE,9O,NC,CE,ZN,M4,EJ,2N,HG,KZ,DD,JH,6N,NA,HW,NW,9E,J3,BJ,UQ,O8,VC,OL,OA,WY,N3,OG,8Q,R2,OX,ON,OJ,O7,Y5,BL,3F,8P,Q8,LW,PK,0P,9P,PF,7Q,P8,HI,3O,7V,6D,KS,4B,PR,PU,PO,PH,PD,NI,PW,PB,P1,EB,QF,QR,RT,YS,ZL,WQ,FV,RR,AT,BI,RJ,RK,RA,RH,WB,RD,FR,4Z,4Q,S6,MM,ZS,E5,C7,S3,SK,BU,HZ,SP,S4,SV,W7,YR,CB,NL,SC,FM,ZH,8S,S5,5M,S7,3U,FT,MI,Y7,SQ,N5,H2,5P,XW,I6,NE,BC,5G,XT,JZ,OO,XR,QS,8R,IE,SO,SA,YB,YG,DG,WN,JK,SG,NK,9C,UL,SJ,2S,2I,NB,8F,SD,PI,SY,2U,PY,Q4,LX,7E,RB,DT,TA,T0,VR,R9,7J,PZ,JJ,EQ,QT,TQ,TP,RO,SF,U9,T6,FD,TG,T9,TR,WU,3V,7T,AX,UN,GE,HV,TH,9T,PM,OR,JE,UG,TU,3T,TK,T7,VO,PS,UF,B7,UA,EU,5X,U6,US,UT,HY,VA,VF,6Z,RG,LC,V4,VM,VN,NN,VQ,V6,VX,VS,DJ,VK,V2,ZG,VB,XF,VG,VE,VY,4W,WT,2W,8O,WS,WF,WM,IV,IW,8Z,WO,8V,JN,SE,XP,R3,YE,Y8,Y0,IY,4Y,Q3,B4,WS'
-- =============================================
CREATE PROCEDURE [dbo].[USP_GetAlternativeOption]
	-- Add the parameters for the stored procedure here
	@AirRequestKey int
	,@AirRequestType Varchar(20)
	,@AllowedAirline Varchar(100) = ''
	,@PriceLimit Float = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	
	Declare @AirSubRequestKey int
	
	If(@AirRequestType = 'RoundTrip' OR @AirRequestType = 'Multicity')
	Begin
		select @AirSubRequestKey = airSubRequestKey from AirSubRequest where airRequestKey = @AirRequestKey and airSubRequestLegIndex = -1
    End
    Else
    Begin
		select @AirSubRequestKey = airSubRequestKey from AirSubRequest where airRequestKey = @AirRequestKey and airSubRequestLegIndex = 1
    End
		
		DECLARE @AirSegments AS  TABLE    
		(
		 airSegmentKey uniqueidentifier,airResponseKey uniqueidentifier,airLegNumber int NOT NULL,airSegmentMarketingAirlineCode varchar(2),  
		 airSegmentOperatingAirlineCode varchar(2),airSegmentFlightNumber int,airSegmentDuration time(7),airSegmentEquipment nvarchar(50)  ,  
		 airSegmentMiles int,airSegmentDepartureDate datetime,airSegmentArrivalDate datetime,airSegmentDepartureAirport varchar(50),  
		 airSegmentArrivalAirport varchar(50),airSegmentResBookDesigCode varchar(50),airSegmentDepartureOffset float,  
		 airSegmentArrivalOffset float,airSegmentSeatRemaining  int,airSegmentMarriageGrp char(10),airFareBasisCode varchar(50) ,  
		 airFareReferenceKey varchar(400),airSegmentOperatingFlightNumber int,airsegmentCabin varchar (20) ,segmentOrder int,airSegmentOperatingAirlineCompanyShortName varchar(100)   
		)
		
		DECLARE @airResponseResultset TABLE   
		(  
		  airSegmentKey uniqueidentifier,airResponseKey uniqueidentifier,airLegNumber int,airSegmentMarketingAirlineCode varchar(10)
		  ,airSegmentFlightNumber varchar(50),airSegmentDuration time,airSegmentEquipment varchar(50),airSegmentMiles int,airSegmentDepartureDate datetime  
		  ,airSegmentArrivalDate datetime,airSegmentDepartureAirport  varchar(50),airSegmentArrivalAirport  varchar(50),airPrice float 
		  ,airPriceTax float,airPriceBaseSenior float,airPriceTaxSenior float,airPriceBaseChildren float,airPriceTaxChildren float
		  ,airPriceBaseInfant float,airPriceTaxInfant float,airPriceBaseYouth float,airPriceTaxYouth float,AirPriceBaseTotal float
		  ,AirPriceTaxTotal float,airPriceBaseDisplay float,airPriceTaxDisplay float,airRequestKey int,gdsSourceKey int,MarketingAirlineName  varchar(50)
		  ,NoOfStops int,actualTakeOffDateForLeg datetime,actualLandingDateForLeg datetime,airSegmentOperatingAirlineCode varchar(10)
		  ,airSegmentResBookDesigCode varchar(3),noofAirlines int,airlineName varchar(50),airsegmentDepartureOffset float,airSegmentArrivalOffset float
		  ,airSegmentSeatRemaining int,priceClassCommentsSuperSaver varchar(500),priceClassCommentsEconSaver varchar(500),priceClassCommentsFirstFlex varchar(500)
		  ,priceClassCommentsCorporate varchar(500),priceClassCommentsEconFlex varchar(500),priceClassCommentsEconUpgrade varchar(500),airSuperSaverPrice float
		  ,airEconSaverPrice float,airFirstFlexPrice  float,airCorporatePrice  float,airEconFlexPrice float,airEconUpgradePrice float,airClassSuperSaver varchar (50) NULL  
		  ,airClassEconSaver    varchar (50) NULL,airClassFirstFlex varchar (50) NULL,airClassCorporate varchar (50) NULL,airClassEconFlex varchar (50) NULL
		  ,airClassEconUpgrade   varchar (50) NULL,airSuperSaverSeatRemaining   int  NULL,airEconSaverSeatRemaining   int  NULL,airFirstFlexSeatRemaining   int  NULL,  
		  airCorporateSeatRemaining   int  NULL,airEconFlexSeatRemaining   int  NULL,airEconUpgradeSeatRemaining   int  NULL,airSuperSaverFareReferenceKey   varchar (50) NULL,  
		  airEconSaverFareReferenceKey   varchar (50) NULL,airFirstFlexFareReferenceKey   varchar (50) NULL,airCorporateFareReferenceKey   varchar (50) NULL,  
		  airEconFlexFareReferenceKey   varchar (50) NULL,airEconUpgradeFareReferenceKey   varchar (50) NULL,  airPriceClassSelected   varchar (50) NULL ,  
		  otherLegPrice float ,  isRefundable bit ,  isbrandedFare bit ,  cabinClass varchar(20) ,  fareType varchar (20),segmentOrder int ,airsegmentCabin varchar (20),  
		  totalCost float ,airSegmentOperatingFlightNumber int, otherlegtax float , isgeneratedBundle bit  ,
		  airSegmentOperatingAirlineCompanyShortName varchar(100)
		)
		
		DECLARE @AirResponseKey AS  TABLE ( AirResponseKey uniqueidentifier ) 
		DECLARE @Airline AS  TABLE ( AirlineCode Varchar(5))  
		  
		INSERT into @AirSegments(airSegmentKey,airResponseKey,airLegNumber,airSegmentMarketingAirlineCode,airSegmentOperatingAirlineCode
		,airSegmentFlightNumber,airSegmentDuration,airSegmentEquipment,airSegmentMiles,airSegmentDepartureDate,airSegmentArrivalDate
		,airSegmentDepartureAirport,airSegmentArrivalAirport,airSegmentResBookDesigCode,airSegmentDepartureOffset,airSegmentArrivalOffset 
		,airSegmentSeatRemaining,airSegmentMarriageGrp ,airFareBasisCode ,airFareReferenceKey,airSegmentOperatingFlightNumber,airsegmentCabin,segmentOrder,airSegmentOperatingAirlineCompanyShortName)  
		(SELECT airSegmentKey,SEG.airResponseKey,airLegNumber,airSegmentMarketingAirlineCode,airSegmentOperatingAirlineCode,airSegmentFlightNumber
		,airSegmentDuration,(case when AircraftsLookup.AircraftName IS NULL then airSegmentEquipment else AircraftsLookup.AircraftName end) as airSegmentEquipment
		,airSegmentMiles,airSegmentDepartureDate,airSegmentArrivalDate,airSegmentDepartureAirport,airSegmentArrivalAirport,airSegmentResBookDesigCode
		,airSegmentDepartureOffset,airSegmentArrivalOffset ,airSegmentSeatRemaining,airSegmentMarriageGrp ,airFareBasisCode ,airFareReferenceKey
		,airSegmentOperatingFlightNumber,airsegmentCabin,segmentOrder ,airSegmentOperatingAirlineCompanyShortName
		From AirSegments seg With (NoLock)
		INNER JOIN AirResponse resp With (NoLock) ON seg .airResponseKey = resp.airresponsekey    
		--INNER JOIN AirSubRequest sub on sub.airSubRequestKey = resp.airSubRequestKey   
		LEFT OUTER JOIN AircraftsLookup With (NoLock) on (seg.airSegmentEquipment = AircraftsLookup.SubTypeCode AND AircraftsLookup.SubTypeCode = AircraftsLookup.AircraftCode)  
		WHERE  resp.airSubRequestKey  = @AirSubRequestKey)
				
		IF(@PriceLimit = 0)
		BEGIN
			INSERT into @airResponseResultset (airSegmentKey, airResponseKey,airLegNumber,airSegmentMarketingAirlineCode,airSegmentFlightNumber
			,airSegmentDuration, airSegmentEquipment,airSegmentMiles,airSegmentDepartureDate,airSegmentArrivalDate ,airSegmentDepartureAirport
			,airSegmentArrivalAirport,airPrice,MarketingAirlineName,NoOfStops ,actualTakeOffDateForLeg,actualLandingDateForLeg ,airSegmentOperatingAirlineCode 
			, airSegmentResBookDesigCode,noofAirlines ,airlineName , gdsSourceKey ,airPriceTax ,airRequestKey 
			,airsegmentDepartureOffset,airSegmentArrivalOffset ,airSegmentSeatRemaining,priceClassCommentsSuperSaver,priceClassCommentsEconSaver 
			,priceClassCommentsFirstFlex ,priceClassCommentsCorporate,priceClassCommentsEconFlex,priceClassCommentsEconUpgrade, airSuperSaverPrice 
			,airEconSaverPrice ,airFirstFlexPrice ,airCorporatePrice,airEconFlexPrice,airEconUpgradePrice ,airClassSuperSaver,airClassEconSaver
			,airClassFirstFlex,airClassCorporate,airClassEconFlex,airClassEconUpgrade,airSuperSaverSeatRemaining,airEconSaverSeatRemaining
			,airFirstFlexSeatRemaining,airCorporateSeatRemaining,airEconFlexSeatRemaining,airEconUpgradeSeatRemaining, airPriceClassSelected
			,otherLegPrice,isRefundable,isBrandedFare  ,cabinClass ,fareType,segmentOrder ,airsegmentCabin ,totalCost,
			airSegmentOperatingFlightNumber ,otherlegtax ,isgeneratedBundle,airPriceBaseSenior,airPriceTaxSenior,airPriceBaseChildren,airPriceTaxChildren
			,airPriceBaseInfant,airPriceTaxInfant,AirPriceBaseTotal,AirPriceTaxTotal,airPriceBaseDisplay, airPriceTaxDisplay ,airSegmentOperatingAirlineCompanyShortName)  
			SELECT  seg.airSegmentKey, seg.airResponseKey, seg.airLegNumber, seg. airSegmentMarketingAirlineCode ,seg. airSegmentFlightNumber, seg.airSegmentDuration , seg.airSegmentEquipment , seg.airSegmentMiles , seg.airSegmentDepartureDate , seg.airSegmentArrivalDate , seg.airSegmentDepartureAirport , seg.airSegmentArrivalAirport  
			,resp.airPriceBase AS airPriceBase , airVendor.ShortName AS MarketingAirlineName , 0,  seg.airSegmentDepartureDate,seg.airSegmentArrivalDate
			,airSegmentOperatingAirlineCode , seg.airSegmentResBookDesigCode,0,seg.airSegmentMarketingAirlineCode,2,resp.airpriceTax,resp.airSubRequestKey,airsegmentDepartureOffset,airSegmentArrivalOffset ,airSegmentSeatRemaining,priceClassCommentsSuperSaver ,priceClassCommentsEconSaver,
			priceClassCommentsFirstFlex ,priceClassCommentsCorporate,priceClassCommentsEconFlex,priceClassCommentsEconUpgrade,airSuperSaverPrice ,airEconSaverPrice ,airFirstFlexPrice ,airCorporatePrice ,airEconFlexPrice,airEconUpgradePrice,airClassSuperSaver,
			airClassEconSaver,airClassFirstFlex,airClassCorporate,airClassEconFlex,airClassEconUpgrade,airSuperSaverSeatRemaining,airEconSaverSeatRemaining,airFirstFlexSeatRemaining,airCorporateSeatRemaining,airEconFlexSeatRemaining,airEconUpgradeSeatRemaining, airPriceClassSelected ,   
			0,refundable   ,isBrandedFare,resp.cabinClass, fareType,segmentOrder ,seg.airsegmentCabin,(isnull(resp.airPriceBase,0) + ISNULL (resp.airpriceTax,0) ),seg.airSegmentOperatingFlightNumber,0,isGeneratedBundle,
			airPriceBaseSenior,airPriceTaxSenior,airPriceBaseChildren,airPriceTaxChildren,airPriceBaseInfant,airPriceTaxInfant,AirPriceBaseTotal,AirPriceTaxTotal,airPriceBaseDisplay, airPriceTaxDisplay ,seg.airSegmentOperatingAirlineCompanyShortName  
			FROM @AirSegments seg 
			INNER JOIN AirResponse resp ON seg .airresponsekey = resp.airResponseKey   
			INNER JOIN  AirVendorLookup airVendor   ON seg.airSegmentMarketingAirlineCode = airVendor.AirlineCode 
			Where resp.airSubRequestKey = @AirSubRequestKey
		END
		ELSE
		BEGIN
			INSERT into @airResponseResultset (airSegmentKey, airResponseKey,airLegNumber,airSegmentMarketingAirlineCode,airSegmentFlightNumber
			,airSegmentDuration, airSegmentEquipment,airSegmentMiles,airSegmentDepartureDate,airSegmentArrivalDate ,airSegmentDepartureAirport
			,airSegmentArrivalAirport,airPrice,MarketingAirlineName,NoOfStops ,actualTakeOffDateForLeg,actualLandingDateForLeg ,airSegmentOperatingAirlineCode 
			, airSegmentResBookDesigCode,noofAirlines ,airlineName , gdsSourceKey ,airPriceTax ,airRequestKey 
			,airsegmentDepartureOffset,airSegmentArrivalOffset ,airSegmentSeatRemaining,priceClassCommentsSuperSaver,priceClassCommentsEconSaver 
			,priceClassCommentsFirstFlex ,priceClassCommentsCorporate,priceClassCommentsEconFlex,priceClassCommentsEconUpgrade, airSuperSaverPrice 
			,airEconSaverPrice ,airFirstFlexPrice ,airCorporatePrice,airEconFlexPrice,airEconUpgradePrice ,airClassSuperSaver,airClassEconSaver
			,airClassFirstFlex,airClassCorporate,airClassEconFlex,airClassEconUpgrade,airSuperSaverSeatRemaining,airEconSaverSeatRemaining
			,airFirstFlexSeatRemaining,airCorporateSeatRemaining,airEconFlexSeatRemaining,airEconUpgradeSeatRemaining, airPriceClassSelected
			,otherLegPrice,isRefundable,isBrandedFare  ,cabinClass ,fareType,segmentOrder ,airsegmentCabin ,totalCost,
			airSegmentOperatingFlightNumber ,otherlegtax ,isgeneratedBundle,airPriceBaseSenior,airPriceTaxSenior,airPriceBaseChildren,airPriceTaxChildren
			,airPriceBaseInfant,airPriceTaxInfant,AirPriceBaseTotal,AirPriceTaxTotal,airPriceBaseDisplay, airPriceTaxDisplay,airSegmentOperatingAirlineCompanyShortName )  
			SELECT  seg.airSegmentKey, seg.airResponseKey, seg.airLegNumber, seg. airSegmentMarketingAirlineCode ,seg. airSegmentFlightNumber, seg.airSegmentDuration , seg.airSegmentEquipment , seg.airSegmentMiles , seg.airSegmentDepartureDate , seg.airSegmentArrivalDate , seg.airSegmentDepartureAirport , seg.airSegmentArrivalAirport  
			,resp.airPriceBase AS airPriceBase , airVendor.ShortName AS MarketingAirlineName , 0,  seg.airSegmentDepartureDate,seg.airSegmentArrivalDate
			,airSegmentOperatingAirlineCode , seg.airSegmentResBookDesigCode,0,seg.airSegmentMarketingAirlineCode,2,resp.airpriceTax,resp.airSubRequestKey,airsegmentDepartureOffset,airSegmentArrivalOffset ,airSegmentSeatRemaining,priceClassCommentsSuperSaver ,priceClassCommentsEconSaver,
			priceClassCommentsFirstFlex ,priceClassCommentsCorporate,priceClassCommentsEconFlex,priceClassCommentsEconUpgrade,airSuperSaverPrice ,airEconSaverPrice ,airFirstFlexPrice ,airCorporatePrice ,airEconFlexPrice,airEconUpgradePrice,airClassSuperSaver,
			airClassEconSaver,airClassFirstFlex,airClassCorporate,airClassEconFlex,airClassEconUpgrade,airSuperSaverSeatRemaining,airEconSaverSeatRemaining,airFirstFlexSeatRemaining,airCorporateSeatRemaining,airEconFlexSeatRemaining,airEconUpgradeSeatRemaining, airPriceClassSelected ,   
			0,refundable   ,isBrandedFare,resp.cabinClass, fareType,segmentOrder ,seg.airsegmentCabin,(isnull(resp.airPriceBase,0) + ISNULL (resp.airpriceTax,0) ),seg.airSegmentOperatingFlightNumber,0,isGeneratedBundle,
			airPriceBaseSenior,airPriceTaxSenior,airPriceBaseChildren,airPriceTaxChildren,airPriceBaseInfant,airPriceTaxInfant,AirPriceBaseTotal,AirPriceTaxTotal,airPriceBaseDisplay, airPriceTaxDisplay,airSegmentOperatingAirlineCompanyShortName   
			FROM @AirSegments seg 
			INNER JOIN AirResponse resp ON seg .airresponsekey = resp.airResponseKey   
			INNER JOIN  AirVendorLookup airVendor   ON seg.airSegmentMarketingAirlineCode = airVendor.AirlineCode 
			Where resp.airSubRequestKey = @AirSubRequestKey
			And (airPriceBaseDisplay + airPriceTaxDisplay) <= @PriceLimit
		END
		
		If(@AllowedAirline <> '')
		Begin
			Insert into @Airline
			SELECT * FROM vault.dbo.ufn_CSVToTable (@AllowedAirline)
			
			If((Select Top 1 AirlineCode From @Airline) <> '(all)')
			Begin
				Insert into @AirResponseKey
				Select airResponseKey from @AirSegments Where airSegmentOperatingAirlineCode not in (SELECT AirlineCode FROM @Airline)
				
				Insert into @AirResponseKey
				Select airResponseKey from @AirSegments Where airSegmentMarketingAirlineCode not in (SELECT AirlineCode FROM @Airline)
				
				Insert into @AirResponseKey
				Select airResponseKey from @airResponseResultset Where airSegmentMarketingAirlineCode not in (SELECT AirlineCode FROM @Airline)
				
				Insert into @AirResponseKey
				Select airResponseKey from @airResponseResultset Where airSegmentOperatingAirlineCode not in (SELECT AirlineCode FROM @Airline)
				
				Delete From @airResponseResultset Where airResponseKey in (select distinct AirResponseKey from @AirResponseKey)
				
				Delete From @AirSegments Where airResponseKey in (select distinct AirResponseKey from @airResponseResultset)
			End	
		End
		
		SELECT distinct air.*, airSegmentArrivalOffset,departureAirport .CityName AS DepartureAirPortCityName ,departureAirport.StateCode AS DepartureAirportStateCode ,departureAirport .AirportName AS DepartureAirportName , departureAirport.CountryCode
		AS DepartureAirportCountryCode,   
		arrivalAirport .CItyName AS ArrivalAirPortCityName ,arrivalAirport .StateCode AS ArrivalAirportStateCode , arrivalAirport .AirportName AS ArrivalAirportName ,arrivalAirport .CountryCode  AS ArrivalAirportCountryCode,  
		operatingAirline .ShortName AS OperatingAirlineName,isRefundable ,isbrandedFare FROM @airResponseResultset air 
		LEFT OUTER JOIN AirVendorLookup operatingAirline    ON air .airSegmentOperatingAirlineCode = operatingAirline .AirlineCode   
		LEFT OUTER JOIN AirportLookup departureAirport   ON air .airSegmentDepartureAirport = departureAirport .AirportCode   
		LEFT OUTER JOIN AirportLookup arrivalAirport    ON air .airSegmentArrivalAirport =arrivalAirport .AirportCode   
		order by airResponseKey, airLegNumber ,segmentOrder, airSegmentDepartureDate  
	
END
GO
